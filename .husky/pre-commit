#!/usr/bin/env sh
set -e

echo "➤ Running pre-commit checks..."

has_ts=false
has_js=false
has_prisma=false
has_openapi=false

staged_files=$(git diff --cached --name-only)
old_ifs=$IFS
IFS='
'
for staged_file in $staged_files; do
  case "$staged_file" in
    *.ts|*.tsx)
      has_ts=true
      ;;
    *.js|*.jsx|*.mdx)
      has_js=true
      ;;
    prisma/*)
      has_prisma=true
      ;;
    docs/api/openapi.yaml)
      has_openapi=true
      ;;
  esac
done
IFS=$old_ifs

should_run_lint_staged=false

if $has_ts || $has_js || $has_prisma; then
  should_run_lint_staged=true
fi

run_step() {
  local exec_cmd="$1"
  local description="$2"
  local label="$3"
  local warn_on_changes="${4:-false}"

  # Print initial line (two-space indent)
  printf "    ➤ %s...\r" "$description"

  if sh -c "$exec_cmd" >/dev/null 2>&1; then
    # Clear line, then print success
    printf "\033[2K\r    ☑️ %s run and passed\n" "$label"

    # Check if there are modifications to warn about
    if [ "$warn_on_changes" = "true" ]; then
      if [ -n "$(git diff --name-only)" ]; then
        printf "    ⚠️  Some files were modified. Review and stage them before committing again.\n"
      fi
    fi
  else
    # Clear line, then print failure
    printf "\033[2K\r    ❌ %s failed. Run manually:\n    %s\n" "$label" "$exec_cmd"
    exit 1
  fi
}

skip_step() {
  local cmd="$1"
  local reason="$2"
  printf "    ✔️  %s skipped (%s)\n" "$cmd" "$reason"
}

any_checks_run=false

if $has_openapi; then
  run_step "pnpm run openapi:check" "Checking OpenAPI spec" "openapi:check"
  any_checks_run=true
else
  skip_step "openapi:check" "no OpenAPI spec changes"
fi

if $should_run_lint_staged; then
  run_step "pnpm lint-staged" "Running lint-staged checks" "lint-staged" "true"
  any_checks_run=true
else
  skip_step "lint-staged" "no matching staged files"
fi

if $has_ts || $has_js; then
  run_step "pnpm run typecheck" "Running typecheck" "typecheck"
  any_checks_run=true
else
  skip_step "typecheck" "no TS/JS changes"
fi

run_step "pnpm test" "Running tests" "Test Suites"
if ! $any_checks_run; then
  echo "✅ No relevant files changed. Skipping checks."
else
  echo "✅ All pre-commit checks passed successfully."
fi
