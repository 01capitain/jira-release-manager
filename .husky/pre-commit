#!/usr/bin/env sh
set -e

echo "➤ Running pre-commit checks..."

# Get list of staged files
staged_files=$(git diff --cached --name-only)

has_ts=false
has_js=false
has_prisma=false
has_openapi=false

for file in $staged_files; do
  case "$file" in
    *.ts|*.tsx)
      has_ts=true
      ;;
    *.js|*.jsx|*.mdx)
      has_js=true
      ;;
    prisma/*)
      has_prisma=true
      ;;
    docs/api/openapi.yaml)
      has_openapi=true
      ;;
  esac
done

run_step() {
  local cmd="$1"
  local description="$2"

  # Print initial line (two-space indent)
  printf "    ➤ %s...\r" "$description"

  if pnpm run "$cmd" >/dev/null 2>&1; then
    # Clear line, then print success
    printf "\033[2K\r    ✔️ %s run and passed\n" "$cmd"
  else
    # Clear line, then print failure
    printf "\033[2K\r    ❌ %s failed. Run manually:\n    pnpm run %s\n" "$cmd" "$cmd"
    exit 1
  fi
}

skip_step() {
  local cmd="$1"
  local reason="$2"
  printf "    ☑️ %s skipped (%s)\n" "$cmd" "$reason"
}

any_checks_run=false

if $has_openapi; then
  run_step "openapi:check" "Checking OpenAPI spec"
  any_checks_run=true
else
  skip_step "openapi:check" "no OpenAPI spec changes"
fi

if $has_ts || $has_js;  then
  run_step "typecheck" "Running typecheck"
  run_step "lint:fix" "Linting and fixing files before commit"
  run_step "format:write" "Formatting files before commit"
  any_checks_run=true
else
  skip_step "typecheck" "no TS/JS changes"
  skip_step "lint:fix" "no TS/JS changes"
  skip_step "format:write" "no TS/JS changes"
fi

if $has_prisma; then
  run_step "db:lint" "Linting Prisma schema"
  any_checks_run=true
else
  skip_step "db:lint" "no Prisma schema changes"
fi

if ! $any_checks_run; then
  echo "✅ No relevant files changed. Skipping checks."
else
  echo "✅ All pre-commit checks passed successfully."
fi